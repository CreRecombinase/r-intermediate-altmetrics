<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: Intermediate programming with R</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">Intermediate programming with R</h1></a>
          <h2 class="subtitle">Testing with testit</h2>
          <section class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Write assertion statements with <code>assert</code></li>
<li>Confirm errors using <code>has_error</code></li>
<li>Confirm warnings using <code>has_warning</code></li>
<li>Use unit tests to confirm code is working as expected</li>
</ul>
</div>
</section>
<p>Using assertion statements is a good first step to writing more reliable code. Going the next step, we can pass inputs to a function and confirm that the result is what we expect. Tests that check a function works properly are called unit tests (because each function is a unit of the overall code we are writing). Writing tests gives us confidence that our code works in different situations, serves as explicit documentation of how a function is supposed to work, and alerts us to any changes due to software updates.</p>
<p>In this lesson we will use the simple testing framework in the package <a href="https://cran.r-project.org/web/packages/testit/index.html">testit</a>. There are other more elaborate testing frameworks such as <a href="https://cran.r-project.org/web/packages/RUnit/index.html">RUnit</a> and <a href="https://cran.r-project.org/web/packages/testthat/index.html">testthat</a> if you need more complicated testing in the future. Also, as a caveat, R testing frameworks work best in the context of an R package. They will be less flexible in our context testing functions that are not part of an R package.</p>
<h3 id="using-the-testit-package">Using the testit package</h3>
<p>Let’s first load the package.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;testit&quot;</span>)</code></pre>
<p>In the last lesson, we wrote assertion statements using <code>stopifnot</code>. However, the error messages generated by <code>stopifnot</code> are cryptic unless we are familiar with the intricacies of a specific function. This can be difficult when writing lots of code or returning to code written long ago. The main function of the testit package is <code>assert</code>, which allows us to include a message that is printed if the assertion fails. This makes it easier to interpret what went wrong.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;one equals one&quot;</span>, <span class="dv">1</span> ==<span class="st"> </span><span class="dv">1</span>)
<span class="kw">assert</span>(<span class="st">&quot;two plus two equals five&quot;</span>, <span class="dv">2</span> +<span class="st"> </span><span class="dv">2</span> ==<span class="st"> </span><span class="dv">5</span>)</code></pre>
<pre class="output"><code>assertion failed: two plus two equals five
</code></pre>
<pre class="error"><code>Error: 2 + 2 == 5 is not TRUE
</code></pre>
<p>And similar to <code>stopifnot</code>, we can list multiple statements to check.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;these statements are TRUE&quot;</span>, <span class="dv">1</span> ==<span class="st"> </span><span class="dv">1</span>, <span class="dv">2</span> ==<span class="st"> </span><span class="dv">2</span>, <span class="dv">3</span> ==<span class="st"> </span><span class="dv">3</span>)</code></pre>
<p>And if any of them fails, it throws an error.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;these statements are TRUE&quot;</span>, <span class="dv">0</span> ==<span class="st"> </span><span class="dv">1</span>, <span class="dv">2</span> ==<span class="st"> </span><span class="dv">2</span>, <span class="dv">3</span> ==<span class="st"> </span><span class="dv">3</span>)</code></pre>
<pre class="output"><code>assertion failed: these statements are TRUE
</code></pre>
<pre class="error"><code>Error: 0 == 1 is not TRUE
</code></pre>
<p>Furthermore, the package has functions to that detect if an error or warning was produced. From their documentation:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># No warning</span>
<span class="kw">has_warning</span>(<span class="dv">1</span> +<span class="st"> </span><span class="dv">1</span>)</code></pre>
<pre class="output"><code>[1] FALSE
</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Issues warning because vectors have different lengths</span>
<span class="kw">has_warning</span>(<span class="dv">1</span>:<span class="dv">2</span> +<span class="st"> </span><span class="dv">1</span>:<span class="dv">3</span>)</code></pre>
<pre class="output"><code>[1] TRUE
</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># No error</span>
<span class="kw">has_error</span>(<span class="dv">2</span> -<span class="st"> </span><span class="dv">3</span>)</code></pre>
<pre class="output"><code>[1] FALSE
</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Throws error because cannot add numeric and character vectors</span>
<span class="kw">has_error</span>(<span class="dv">1</span> +<span class="st"> &quot;a&quot;</span>)</code></pre>
<pre class="output"><code>[1] TRUE
</code></pre>
<p>We can combine these with <code>assert</code> to confirm that our functions throw errors or warnings when given certain inputs.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Throws error&quot;</span>, <span class="kw">has_error</span>(<span class="dv">1</span> +<span class="st"> &quot;a&quot;</span>))</code></pre>
<h3 id="writing-unit-tests-for-a-function">Writing unit tests for a function</h3>
<p>In the challenge for the last lesson we added assertion statements using <code>stopifnot</code> to the function <code>calc_sum_stat</code>. Also we fixed the problem with <code>NA</code>s by adding the argument <code>na.rm = TRUE</code> to <code>mean</code>. The result should have looked something like the following:</p>
<pre class="sourceCode r"><code class="sourceCode r">calc_sum_stat &lt;-<span class="st"> </span>function(df, cols) {
  <span class="kw">stopifnot</span>(<span class="kw">dim</span>(df) &gt;<span class="st"> </span><span class="dv">0</span>,
            <span class="kw">is.character</span>(cols),
            cols %in%<span class="st"> </span><span class="kw">colnames</span>(df))
  if (<span class="kw">length</span>(cols) ==<span class="st"> </span><span class="dv">1</span>) {
    <span class="kw">warning</span>(<span class="st">&quot;Only one column specified. Calculating the mean will not change anything.&quot;</span>)
  }
  df_sub &lt;-<span class="st"> </span>df[, cols, drop =<span class="st"> </span><span class="ot">FALSE</span>]
  <span class="kw">stopifnot</span>(<span class="kw">is.data.frame</span>(df_sub))
  sum_stat &lt;-<span class="st"> </span><span class="kw">apply</span>(df_sub, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="kw">stopifnot</span>(!<span class="kw">is.na</span>(sum_stat))
  <span class="kw">return</span>(sum_stat)
}</code></pre>
<p>We checked that our function worked properly by testing some different inputs. Let’s convert these into formal units tests that we can automatically run to test our function.</p>
<p>When passing an empty data frame, we expect it to throw an error.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Empty data frame</span>
sum_stat &lt;-<span class="st"> </span><span class="kw">calc_sum_stat</span>(<span class="kw">data.frame</span>(), <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>, <span class="st">&quot;f1000Factor&quot;</span>))</code></pre>
<pre class="error"><code>Error: dim(df) &gt; 0 are not all TRUE
</code></pre>
<p>Which we can convert to a test:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Empty data frame throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(<span class="kw">data.frame</span>(), <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>,
                                               <span class="st">&quot;f1000Factor&quot;</span>))))</code></pre>
<p>We also expect an error when passing a non-character vector for the argument <code>cols</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Non-character cols</span>
sum_stat &lt;-<span class="st"> </span><span class="kw">calc_sum_stat</span>(counts_raw, <span class="dv">1</span>:<span class="dv">3</span>)</code></pre>
<pre class="error"><code>Error: is.character(cols) is not TRUE
</code></pre>
<p>And the test looks like:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Non-character vector input for columns throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="dv">1</span>:<span class="dv">3</span>)))</code></pre>
<p>Testing non-existent column names:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Bad column names</span>
sum_stat &lt;-<span class="st"> </span><span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</code></pre>
<pre class="error"><code>Error: cols %in% colnames(df) are not all TRUE
</code></pre>
<p>Converted to a test:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Column names not in data frame throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))))</code></pre>
<p>Issue a warning if only one column is given to the function.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Issue warning since only one column</span>
sum_stat &lt;-<span class="st"> </span><span class="kw">calc_sum_stat</span>(counts_raw, <span class="st">&quot;mendeleyReadersCount&quot;</span>)</code></pre>
<pre class="error"><code>Warning in calc_sum_stat(counts_raw, &quot;mendeleyReadersCount&quot;): Only one
column specified. Calculating the mean will not change anything.
</code></pre>
<p>And the test:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Selecting only one column issues warning&quot;</span>,
       <span class="kw">has_warning</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="st">&quot;mendeleyReadersCount&quot;</span>)))</code></pre>
<p>Lastly, we passed a column that contains <code>NA</code>s. We fixed this so that <code>mean</code> ignores <code>NA</code>s and returns a numeric answer.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># NA output</span>
sum_stat &lt;-<span class="st"> </span><span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>, <span class="st">&quot;facebookLikeCount&quot;</span>))
<span class="kw">anyNA</span>(sum_stat)</code></pre>
<pre class="output"><code>[1] FALSE
</code></pre>
<p>We can also test this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;NA input does not result in NA output&quot;</span>,
       !<span class="kw">anyNA</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>,
                                          <span class="st">&quot;facebookLikeCount&quot;</span>))))</code></pre>
<p>We have now built an entire test suite that we can automatically run whenever we update the function or update the version of R. This way we always know that the function still works as we initially planned.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">assert</span>(<span class="st">&quot;Empty data frame throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(<span class="kw">data.frame</span>(), <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>,
                                               <span class="st">&quot;f1000Factor&quot;</span>))))
<span class="kw">assert</span>(<span class="st">&quot;Non-character vector input for columns throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="dv">1</span>:<span class="dv">3</span>)))
<span class="kw">assert</span>(<span class="st">&quot;Column names not in data frame throws error&quot;</span>,
       <span class="kw">has_error</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))))
<span class="kw">assert</span>(<span class="st">&quot;Selecting only one column issues warning&quot;</span>,
       <span class="kw">has_warning</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="st">&quot;mendeleyReadersCount&quot;</span>)))
<span class="kw">assert</span>(<span class="st">&quot;NA input does not result in NA output&quot;</span>,
       !<span class="kw">anyNA</span>(<span class="kw">calc_sum_stat</span>(counts_raw, <span class="kw">c</span>(<span class="st">&quot;wosCountThru2010&quot;</span>,
                                          <span class="st">&quot;facebookLikeCount&quot;</span>))))</code></pre>
<h3 id="challenge">Challenge</h3>
<section class="challenge panel panel-success">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pencil"></span>Write some tests</h2>
</div>
<div class="panel-body">
<p>Write unit tests for the function <code>my_mean</code> that you wrote in an earlier lesson. It should look something like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">my_mean &lt;-<span class="st"> </span>function(x) {
  result &lt;-<span class="st"> </span><span class="kw">sum</span>(x) /<span class="st"> </span><span class="kw">length</span>(x)
  <span class="kw">return</span>(result)
}</code></pre>
<p>The input <code>x</code> is a numeric vector, and the output is the mean of the vector of numbers. Some ideas to get started:</p>
<ul>
<li>Pass a vector where you know what the mean is, and assert that the result is correct.</li>
<li>Add some assertion statments to check the input <code>x</code>. Use <code>has_error</code> to test that the function throws an error when given bad input.</li>
<li>Issue a warning if the user passes a vector of length one. Test that the warning is properly issued using <code>has_warning</code>.</li>
<li>Include an <code>NA</code> in the vector where you know the result to see what happens. Do you need to modify the code to pass the test?</li>
</ul>
</div>
</section>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/jdblischak/r-intermediate-altmetrics">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
